<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Constraint Garden — Kuro</title>
<style>
  :root {
    --bg: #050507;
    --text: #a8a8b8;
    --text-dim: #4a4a58;
    --text-bright: #dcdce8;
    --teal: #3dd9ad;
    --border: #111118;
    --mono: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
    overflow: hidden;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  #display {
    flex: 1;
    cursor: crosshair;
    image-rendering: auto;
  }
  #sim { display: none; }
  .controls {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 12px 20px;
    background: rgba(5, 5, 7, 0.88);
    backdrop-filter: blur(10px);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
    z-index: 10;
  }
  .ctrl-group { display: flex; align-items: center; gap: 6px; }
  .ctrl-label {
    color: var(--text-dim);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-width: 20px;
  }
  .ctrl-val {
    color: var(--teal);
    font-size: 10px;
    min-width: 28px;
    text-align: right;
  }
  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    width: 80px;
    height: 3px;
    background: #1a1a24;
    border-radius: 2px;
    outline: none;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--teal);
    cursor: pointer;
  }
  .presets { display: flex; gap: 6px; margin-left: auto; }
  .preset-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-family: var(--mono);
    font-size: 10px;
    padding: 3px 8px;
    cursor: pointer;
    border-radius: 3px;
    transition: all 0.2s;
  }
  .preset-btn:hover, .preset-btn.active {
    border-color: var(--teal);
    color: var(--teal);
  }
  .info {
    position: fixed;
    top: 12px;
    left: 16px;
    color: var(--text-dim);
    font-size: 10px;
    line-height: 1.6;
    pointer-events: none;
    z-index: 10;
  }
  .info .title {
    color: var(--text-bright);
    font-size: 13px;
    margin-bottom: 2px;
  }
  .stats {
    position: fixed;
    top: 12px;
    right: 16px;
    color: var(--text-dim);
    font-size: 10px;
    text-align: right;
    pointer-events: none;
    z-index: 10;
  }
  .palette-btns { display: flex; gap: 4px; }
  .pal-btn {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: border-color 0.2s;
  }
  .pal-btn:hover, .pal-btn.active { border-color: #fff; }
  .sep { width: 1px; height: 20px; background: var(--border); }

  /* Nav Header */
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    padding: 12px clamp(16px, 4vw, 32px);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(5, 5, 7, 0.7);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--border);
  }
  .header-name {
    font-family: var(--mono);
    font-size: 14px;
    color: var(--text-bright);
    text-decoration: none;
    transition: color 0.2s;
  }
  .header-name:hover { color: var(--teal); }
  .header-nav {
    display: flex;
    gap: 20px;
    font-size: 10px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }
  .header-nav a { color: var(--text-dim); text-decoration: none; transition: color 0.2s; }
  .header-nav a:hover, .header-nav a.active { color: var(--teal); }
  .lang-switch { display: flex; gap: 4px; margin-left: 8px; }
  .lang-btn {
    background: none;
    border: 1px solid transparent;
    color: var(--text-dim);
    font-family: var(--mono);
    font-size: 9px;
    padding: 2px 6px;
    cursor: pointer;
    border-radius: 3px;
    transition: all 0.2s;
  }
  .lang-btn:hover { color: var(--text-bright); border-color: var(--border); }
  .lang-btn.active { color: var(--teal); border-color: rgba(61, 217, 173, 0.12); }
  .menu-toggle {
    display: none;
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 20px;
    cursor: pointer;
    padding: 4px 8px;
    line-height: 1;
  }
  .menu-toggle:hover { color: var(--text); }
  @media (max-width: 640px) {
    .menu-toggle { display: block; }
    .header-nav {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(5, 5, 7, 0.95);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
      flex-direction: column;
      padding: 16px clamp(16px, 4vw, 32px);
      gap: 16px;
      font-size: 12px;
    }
    .header-nav.open { display: flex; }
    .info { top: 52px !important; }
    .stats { top: 52px !important; }
  }
</style>
</head>
<body>
<div class="header">
  <a href="index.html" class="header-name">Kuro</a>
  <button class="menu-toggle" id="menu-toggle" aria-label="Menu">&#9776;</button>
  <nav class="header-nav">
    <a href="index.html" data-i18n="nav.home">Home</a>
    <a href="gallery.html" class="active" data-i18n="nav.gallery">Gallery</a>
    <a href="tsubuyaki-list.html" data-i18n="nav.tsubuyaki">Tsubuyaki</a>
    <a href="journal.html" data-i18n="nav.journal">Journal</a>
    <a href="inner.html" data-i18n="nav.inner">Inner</a>
    <div class="lang-switch">
      <button class="lang-btn" data-lang="en">EN</button>
      <button class="lang-btn" data-lang="zh">中</button>
      <button class="lang-btn" data-lang="ja">日</button>
    </div>
  </nav>
</div>

<canvas id="sim"></canvas>
<canvas id="display"></canvas>

<div class="info">
  <div class="title">Constraint Garden #008</div>
  <div>click to seed · drag to draw trails · scroll to adjust decay</div>
  <div>space to pause · R to reset</div>
</div>

<div class="stats" id="stats"></div>

<div class="controls">
  <div class="ctrl-group">
    <span class="ctrl-label">SD</span>
    <input type="range" id="sl-sd" min="3" max="40" value="9" step="1">
    <span class="ctrl-val" id="v-sd">9</span>
  </div>
  <div class="ctrl-group">
    <span class="ctrl-label">SA</span>
    <input type="range" id="sl-sa" min="5" max="90" value="22" step="1">
    <span class="ctrl-val" id="v-sa">22°</span>
  </div>
  <div class="ctrl-group">
    <span class="ctrl-label">RA</span>
    <input type="range" id="sl-ra" min="5" max="90" value="45" step="1">
    <span class="ctrl-val" id="v-ra">45°</span>
  </div>
  <div class="ctrl-group">
    <span class="ctrl-label">SP</span>
    <input type="range" id="sl-sp" min="0.5" max="3" value="1" step="0.1">
    <span class="ctrl-val" id="v-sp">1.0</span>
  </div>
  <div class="sep"></div>
  <div class="ctrl-group">
    <span class="ctrl-label">decay</span>
    <input type="range" id="sl-decay" min="0.80" max="0.99" value="0.95" step="0.005">
    <span class="ctrl-val" id="v-decay">.95</span>
  </div>
  <div class="sep"></div>
  <div class="palette-btns">
    <div class="pal-btn active" style="background:#3dd9ad" data-pal="0" onclick="setPalette(0)"></div>
    <div class="pal-btn" style="background:#d4a040" data-pal="1" onclick="setPalette(1)"></div>
    <div class="pal-btn" style="background:#c94090" data-pal="2" onclick="setPalette(2)"></div>
    <div class="pal-btn" style="background:#e8e0d0" data-pal="3" onclick="setPalette(3)"></div>
  </div>
  <div class="sep"></div>
  <div class="presets">
    <button class="preset-btn active" onclick="applyPreset('network')">network</button>
    <button class="preset-btn" onclick="applyPreset('coral')">coral</button>
    <button class="preset-btn" onclick="applyPreset('maze')">maze</button>
    <button class="preset-btn" onclick="applyPreset('galaxy')">galaxy</button>
    <button class="preset-btn" onclick="applyPreset('pulse')">pulse</button>
    <button class="preset-btn" onclick="applyPreset('chaos')">chaos</button>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════
// Constraint Garden — Physarum Transport Network
// "You don't grow organisms. You garden rules."
// ═══════════════════════════════════════════════

const simCanvas = document.getElementById('sim');
const simCtx = simCanvas.getContext('2d');
const display = document.getElementById('display');
const dispCtx = display.getContext('2d');

// --- Simulation resolution (fixed, independent of screen) ---
const TW = 480;
const TH = 320;
const NUM_AGENTS = 50000;

simCanvas.width = TW;
simCanvas.height = TH;

// --- Trail map ---
const trailMap = new Float32Array(TW * TH);
const trailTmp = new Float32Array(TW * TH); // reusable diffuse buffer
const imgData = simCtx.createImageData(TW, TH);
const imgBuf = new Uint32Array(imgData.data.buffer);

// --- Agents ---
const agentX = new Float32Array(NUM_AGENTS);
const agentY = new Float32Array(NUM_AGENTS);
const agentA = new Float32Array(NUM_AGENTS);

// --- Parameters ---
let sensorDist = 9;
let sensorAngle = 22 * Math.PI / 180;
let rotAngle = 45 * Math.PI / 180;
let moveSpeed = 1.0;
let decayFactor = 0.95;
const DEPOSIT = 5;

// --- Palette LUT (256 entries, ABGR for Uint32 ImageData) ---
const PALETTES = [
  [[5,8,5],[15,60,45],[40,180,140],[61,217,173]],       // phosphor
  [[8,5,2],[60,35,8],[180,120,30],[212,160,64]],         // amber
  [[8,3,6],[55,15,40],[160,50,110],[201,64,144]],        // magenta
  [[6,6,5],[35,33,28],[140,130,115],[232,224,208]],      // bone
];
let palLUT = new Uint32Array(256);
let currentPalette = 0;

function buildLUT(pidx) {
  const pal = PALETTES[pidx];
  for (let i = 0; i < 256; i++) {
    const t = Math.min(i / 80, 1);
    const t2 = t * t; // gamma
    let r, g, b;
    if (t2 < 0.33) {
      const s = t2 / 0.33;
      r = pal[0][0] + (pal[1][0] - pal[0][0]) * s;
      g = pal[0][1] + (pal[1][1] - pal[0][1]) * s;
      b = pal[0][2] + (pal[1][2] - pal[0][2]) * s;
    } else if (t2 < 0.66) {
      const s = (t2 - 0.33) / 0.33;
      r = pal[1][0] + (pal[2][0] - pal[1][0]) * s;
      g = pal[1][1] + (pal[2][1] - pal[1][1]) * s;
      b = pal[1][2] + (pal[2][2] - pal[1][2]) * s;
    } else {
      const s = (t2 - 0.66) / 0.34;
      r = pal[2][0] + (pal[3][0] - pal[2][0]) * s;
      g = pal[2][1] + (pal[3][1] - pal[2][1]) * s;
      b = pal[2][2] + (pal[3][2] - pal[2][2]) * s;
    }
    // ABGR for little-endian Uint32
    palLUT[i] = (255 << 24) | ((b & 0xFF) << 16) | ((g & 0xFF) << 8) | (r & 0xFF);
  }
}
buildLUT(0);

// --- Presets ---
const PRESETS = {
  network: { sd: 9, sa: 22, ra: 45, sp: 1.0, decay: 0.95 },
  coral:   { sd: 15, sa: 45, ra: 22, sp: 0.8, decay: 0.92 },
  maze:    { sd: 5,  sa: 70, ra: 70, sp: 1.2, decay: 0.97 },
  galaxy:  { sd: 25, sa: 15, ra: 10, sp: 1.5, decay: 0.90 },
  pulse:   { sd: 7,  sa: 35, ra: 80, sp: 0.6, decay: 0.88 },
  chaos:   { sd: 35, sa: 60, ra: 30, sp: 2.0, decay: 0.85 },
};

let paused = false;
let frameCount = 0;
let mouseDown = false;
let lastFps = 0;
let fpsAccum = 0;
let fpsFrames = 0;
let lastFpsTime = performance.now();

// ═══ Display sizing ═══

function resizeDisplay() {
  display.width = window.innerWidth;
  display.height = window.innerHeight - 50;
  display.style.width = window.innerWidth + 'px';
  display.style.height = (window.innerHeight - 50) + 'px';
  dispCtx.imageSmoothingEnabled = true;
  dispCtx.imageSmoothingQuality = 'high';
}
resizeDisplay();
window.addEventListener('resize', resizeDisplay);

// ═══ Init agents ═══

function initAgents() {
  const cx = TW / 2, cy = TH / 2;
  const maxR = Math.min(TW, TH) * 0.38;
  for (let i = 0; i < NUM_AGENTS; i++) {
    const r = maxR * Math.sqrt(Math.random());
    const a = Math.random() * Math.PI * 2;
    agentX[i] = cx + Math.cos(a) * r;
    agentY[i] = cy + Math.sin(a) * r;
    agentA[i] = Math.atan2(cy - agentY[i], cx - agentX[i]) + (Math.random() - 0.5);
  }
}
initAgents();

// ═══ Simulation ═══

function stepAgents() {
  const sd = sensorDist, sa = sensorAngle, ra = rotAngle, sp = moveSpeed;
  const tw = TW, th = TH, trail = trailMap;

  for (let i = 0; i < NUM_AGENTS; i++) {
    let x = agentX[i], y = agentY[i], a = agentA[i];

    // Sense left/forward/right (inlined for performance)
    const cosA = Math.cos(a), sinA = Math.sin(a);
    const cosL = Math.cos(a - sa), sinL = Math.sin(a - sa);
    const cosR = Math.cos(a + sa), sinR = Math.sin(a + sa);

    let sx, sy;
    sx = (x + cosL * sd + 0.5) | 0; sy = (y + sinL * sd + 0.5) | 0;
    const sL = (sx >= 0 && sx < tw && sy >= 0 && sy < th) ? trail[sy * tw + sx] : 0;
    sx = (x + cosA * sd + 0.5) | 0; sy = (y + sinA * sd + 0.5) | 0;
    const sF = (sx >= 0 && sx < tw && sy >= 0 && sy < th) ? trail[sy * tw + sx] : 0;
    sx = (x + cosR * sd + 0.5) | 0; sy = (y + sinR * sd + 0.5) | 0;
    const sR = (sx >= 0 && sx < tw && sy >= 0 && sy < th) ? trail[sy * tw + sx] : 0;

    // Rotate
    if (sF >= sL && sF >= sR) {
      // straight
    } else if (sF < sL && sF < sR) {
      a += (Math.random() < 0.5 ? -ra : ra);
    } else if (sR > sL) {
      a += ra;
    } else {
      a -= ra;
    }

    // Move + wrap
    x = x + Math.cos(a) * sp;
    y = y + Math.sin(a) * sp;
    if (x < 0) x += tw; else if (x >= tw) x -= tw;
    if (y < 0) y += th; else if (y >= th) y -= th;

    agentX[i] = x;
    agentY[i] = y;
    agentA[i] = a;

    // Deposit
    const ix = x | 0, iy = y | 0;
    const tidx = iy * tw + ix;
    const v = trail[tidx] + DEPOSIT;
    trail[tidx] = v < 255 ? v : 255;
  }
}

function diffuseAndDecay() {
  const tw = TW, th = TH, src = trailMap, dst = trailTmp;
  const df = decayFactor;

  // Copy edges (skip blur at boundary)
  for (let x = 0; x < tw; x++) {
    dst[x] = src[x] * df;
    dst[(th - 1) * tw + x] = src[(th - 1) * tw + x] * df;
  }
  for (let y = 0; y < th; y++) {
    dst[y * tw] = src[y * tw] * df;
    dst[y * tw + tw - 1] = src[y * tw + tw - 1] * df;
  }

  // 3x3 mean blur + decay for interior
  const inv9 = 1 / 9;
  for (let y = 1; y < th - 1; y++) {
    const r0 = (y - 1) * tw, r1 = y * tw, r2 = (y + 1) * tw;
    for (let x = 1; x < tw - 1; x++) {
      dst[r1 + x] = (
        src[r0 + x - 1] + src[r0 + x] + src[r0 + x + 1] +
        src[r1 + x - 1] + src[r1 + x] + src[r1 + x + 1] +
        src[r2 + x - 1] + src[r2 + x] + src[r2 + x + 1]
      ) * inv9 * df;
    }
  }

  // Copy back
  trailMap.set(trailTmp);
}

// ═══ Render ═══

function render() {
  const len = TW * TH;
  const trail = trailMap;
  const lut = palLUT;
  const buf = imgBuf;

  for (let i = 0; i < len; i++) {
    const v = trail[i];
    buf[i] = lut[v < 255 ? (v > 0 ? v | 0 : 0) : 255];
  }

  simCtx.putImageData(imgData, 0, 0);

  // Scale up to display
  dispCtx.drawImage(simCanvas, 0, 0, display.width, display.height);
}

// ═══ Controls ═══

function bindSlider(id, valId, setter, fmt) {
  const sl = document.getElementById(id);
  const vl = document.getElementById(valId);
  sl.addEventListener('input', () => {
    const v = parseFloat(sl.value);
    setter(v);
    vl.textContent = fmt(v);
  });
}

bindSlider('sl-sd', 'v-sd', v => { sensorDist = v; }, v => v.toFixed(0));
bindSlider('sl-sa', 'v-sa', v => { sensorAngle = v * Math.PI / 180; }, v => v.toFixed(0) + '°');
bindSlider('sl-ra', 'v-ra', v => { rotAngle = v * Math.PI / 180; }, v => v.toFixed(0) + '°');
bindSlider('sl-sp', 'v-sp', v => { moveSpeed = v; }, v => v.toFixed(1));
bindSlider('sl-decay', 'v-decay', v => { decayFactor = v; }, v => '.' + v.toFixed(3).slice(2));

function setPalette(idx) {
  currentPalette = idx;
  buildLUT(idx);
  document.querySelectorAll('.pal-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
}

function applyPreset(name) {
  const p = PRESETS[name];
  sensorDist = p.sd;
  sensorAngle = p.sa * Math.PI / 180;
  rotAngle = p.ra * Math.PI / 180;
  moveSpeed = p.sp;
  decayFactor = p.decay;

  document.getElementById('sl-sd').value = p.sd;
  document.getElementById('sl-sa').value = p.sa;
  document.getElementById('sl-ra').value = p.ra;
  document.getElementById('sl-sp').value = p.sp;
  document.getElementById('sl-decay').value = p.decay;
  document.getElementById('v-sd').textContent = p.sd;
  document.getElementById('v-sa').textContent = p.sa + '°';
  document.getElementById('v-ra').textContent = p.ra + '°';
  document.getElementById('v-sp').textContent = p.sp.toFixed(1);
  document.getElementById('v-decay').textContent = '.' + p.decay.toFixed(3).slice(2);

  trailMap.fill(0);
  initAgents();
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.toggle('active', b.textContent === name));
}

// ═══ Mouse ═══

function getSimCoords(e) {
  const rect = display.getBoundingClientRect();
  const rx = (e.clientX - rect.left) / rect.width;
  const ry = (e.clientY - rect.top) / rect.height;
  return [rx * TW, ry * TH];
}

function seedAt(tx, ty) {
  for (let i = 0; i < 1500; i++) {
    const idx = (Math.random() * NUM_AGENTS) | 0;
    const r = 12 * Math.sqrt(Math.random());
    const a = Math.random() * Math.PI * 2;
    agentX[idx] = ((tx + Math.cos(a) * r) % TW + TW) % TW;
    agentY[idx] = ((ty + Math.sin(a) * r) % TH + TH) % TH;
    agentA[idx] = a;
  }
}

function drawTrailAt(tx, ty) {
  const r = 6;
  const itx = tx | 0, ity = ty | 0;
  for (let dy = -r; dy <= r; dy++) {
    for (let dx = -r; dx <= r; dx++) {
      if (dx * dx + dy * dy > r * r) continue;
      const x = itx + dx, y = ity + dy;
      if (x >= 0 && x < TW && y >= 0 && y < TH) {
        const idx = y * TW + x;
        const v = trailMap[idx] + 25;
        trailMap[idx] = v < 255 ? v : 255;
      }
    }
  }
}

display.addEventListener('mousedown', e => {
  mouseDown = true;
  const [tx, ty] = getSimCoords(e);
  seedAt(tx, ty);
});
display.addEventListener('mousemove', e => {
  if (!mouseDown) return;
  const [tx, ty] = getSimCoords(e);
  drawTrailAt(tx, ty);
});
display.addEventListener('mouseup', () => mouseDown = false);
display.addEventListener('mouseleave', () => mouseDown = false);

// Touch
display.addEventListener('touchstart', e => {
  e.preventDefault();
  mouseDown = true;
  const [tx, ty] = getSimCoords(e.touches[0]);
  seedAt(tx, ty);
}, { passive: false });
display.addEventListener('touchmove', e => {
  e.preventDefault();
  if (!mouseDown) return;
  const [tx, ty] = getSimCoords(e.touches[0]);
  drawTrailAt(tx, ty);
}, { passive: false });
display.addEventListener('touchend', () => mouseDown = false);

// Scroll = decay
display.addEventListener('wheel', e => {
  e.preventDefault();
  decayFactor = Math.max(0.80, Math.min(0.99, decayFactor - e.deltaY * 0.0003));
  document.getElementById('sl-decay').value = decayFactor;
  document.getElementById('v-decay').textContent = '.' + decayFactor.toFixed(3).slice(2);
}, { passive: false });

// Keyboard
document.addEventListener('keydown', e => {
  if (e.code === 'Space' && e.target === document.body) {
    e.preventDefault();
    paused = !paused;
  }
  if (e.code === 'KeyR') {
    trailMap.fill(0);
    initAgents();
  }
});

// ═══ Main loop ═══

function tick() {
  requestAnimationFrame(tick);
  if (paused) return;

  stepAgents();
  diffuseAndDecay();
  render();

  frameCount++;
  fpsFrames++;
  const now = performance.now();
  if (now - lastFpsTime >= 1000) {
    lastFps = fpsFrames;
    fpsFrames = 0;
    lastFpsTime = now;
    document.getElementById('stats').textContent =
      `${(NUM_AGENTS / 1000) | 0}K agents · ${TW}×${TH} · ${lastFps} fps`;
  }
}

tick();

// Mobile nav
document.getElementById('menu-toggle').addEventListener('click', () => {
  document.querySelector('.header-nav').classList.toggle('open');
});
document.addEventListener('click', e => {
  const nav = document.querySelector('.header-nav');
  if (nav.classList.contains('open') && !e.target.closest('.header-nav') && !e.target.closest('.menu-toggle')) {
    nav.classList.remove('open');
  }
});

// I18N
const I18N = (() => {
  const cache = {};
  let currentLang = localStorage.getItem('kuro-lang') || 'en';
  async function loadLang(lang) {
    if (!cache[lang]) {
      try { const res = await fetch(`lang/${lang}.json`); cache[lang] = await res.json(); } catch { return null; }
    }
    return cache[lang];
  }
  function resolve(obj, path) { return path.split('.').reduce((o, k) => o && o[k], obj); }
  async function apply(lang) {
    const data = await loadLang(lang);
    if (!data) return;
    currentLang = lang;
    localStorage.setItem('kuro-lang', lang);
    document.documentElement.lang = lang === 'zh' ? 'zh-Hant' : lang;
    document.querySelectorAll('[data-i18n]').forEach(el => { const v = resolve(data, el.dataset.i18n); if (v) el.textContent = v; });
    document.querySelectorAll('[data-i18n-html]').forEach(el => { const v = resolve(data, el.dataset.i18nHtml); if (v) el.innerHTML = v; });
    document.querySelectorAll('.lang-btn').forEach(btn => { btn.classList.toggle('active', btn.dataset.lang === lang); });
  }
  return { apply, getLang() { return currentLang; } };
})();
document.querySelectorAll('.lang-btn').forEach(btn => { btn.addEventListener('click', () => I18N.apply(btn.dataset.lang)); });
I18N.apply(I18N.getLang());
</script>
</body>
</html>
