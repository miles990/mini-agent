<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kuro Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Noto+Sans+TC:wght@300;400;500;600;700&family=Noto+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #08090a;
    --surface: #111214;
    --surface2: #181a1e;
    --surface3: #1e2025;
    --border: #262830;
    --border-subtle: #1c1e24;
    --text: #d4d4d8;
    --text-bright: #f0f0f2;
    --text2: #6b6f7b;
    --text3: #454854;
    --accent: #5eead4;
    --accent-dim: rgba(94, 234, 212, 0.12);
    --accent-glow: rgba(94, 234, 212, 0.06);
    --blue: #60a5fa;
    --blue-dim: rgba(96, 165, 250, 0.12);
    --yellow: #fbbf24;
    --yellow-dim: rgba(251, 191, 36, 0.10);
    --red: #f87171;
    --red-dim: rgba(248, 113, 113, 0.10);
    --purple: #a78bfa;
    --purple-dim: rgba(167, 139, 250, 0.10);
    --orange: #fb923c;
    --mono: 'JetBrains Mono', 'SF Mono', 'Cascadia Code', monospace;
    --sans: 'Noto Sans TC', 'Noto Sans', system-ui, sans-serif;
    --radius: 10px;
    --radius-sm: 6px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    font-size: 13px;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* Noise texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    z-index: 9999;
    pointer-events: none;
    opacity: 0.015;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    background-size: 256px 256px;
  }

  .container {
    max-width: 1140px;
    margin: 0 auto;
    padding: 24px 28px 60px;
  }

  /* ── Header ── */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 0 20px;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border-subtle);
  }

  .header-left {
    display: flex;
    align-items: baseline;
    gap: 10px;
  }

  header h1 {
    font-family: var(--mono);
    font-size: 16px;
    font-weight: 600;
    color: var(--accent);
    letter-spacing: -0.02em;
  }

  header h1 span {
    color: var(--text3);
    font-weight: 300;
    margin-left: 2px;
  }

  .header-version {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text3);
    background: var(--surface2);
    padding: 2px 7px;
    border-radius: 3px;
    letter-spacing: 0.02em;
  }

  .header-controls {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .status-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text2);
  }

  .status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    position: relative;
  }
  .status-dot.ok {
    background: var(--accent);
    box-shadow: 0 0 8px var(--accent-dim);
  }
  .status-dot.ok::after {
    content: '';
    position: absolute;
    inset: -3px;
    border-radius: 50%;
    border: 1px solid rgba(94, 234, 212, 0.2);
    animation: pulse-ring 3s ease-in-out infinite;
  }
  .status-dot.busy { background: var(--yellow); box-shadow: 0 0 8px var(--yellow-dim); }
  .status-dot.error { background: var(--red); }

  @keyframes pulse-ring {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0; transform: scale(1.8); }
  }

  /* ── Today Summary Bar ── */
  .today-bar {
    display: flex;
    gap: 6px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
  }

  .today-chip {
    font-family: var(--mono);
    font-size: 11px;
    padding: 5px 12px;
    border-radius: 20px;
    background: var(--surface);
    border: 1px solid var(--border-subtle);
    color: var(--text2);
    display: flex;
    align-items: center;
    gap: 6px;
    transition: border-color 0.2s;
  }
  .today-chip:hover { border-color: var(--border); }

  .today-chip .chip-icon {
    font-size: 12px;
    opacity: 0.7;
  }

  .today-chip .chip-value {
    color: var(--text-bright);
    font-weight: 600;
  }

  .today-chip.highlight {
    border-color: rgba(94, 234, 212, 0.2);
    background: linear-gradient(135deg, var(--surface) 0%, rgba(94, 234, 212, 0.03) 100%);
  }
  .today-chip.highlight .chip-value { color: var(--accent); }

  /* ── Status Grid ── */
  .status-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    margin-bottom: 28px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius);
    padding: 14px 16px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .stat-card:hover { border-color: var(--border); }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent-dim), transparent);
    opacity: 0;
    transition: opacity 0.3s;
  }
  .stat-card:hover::before { opacity: 1; }

  .stat-label {
    font-family: var(--mono);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text3);
    margin-bottom: 6px;
  }

  .stat-value {
    font-family: var(--mono);
    font-size: 22px;
    font-weight: 600;
    color: var(--text-bright);
    letter-spacing: -0.03em;
    line-height: 1.1;
  }

  .stat-detail {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text2);
    margin-top: 5px;
    line-height: 1.3;
  }

  .stat-value.green { color: var(--accent); }
  .stat-value.yellow { color: var(--yellow); }
  .stat-value.red { color: var(--red); }

  .stat-card:has(.stat-value.yellow) { border-color: rgba(251, 191, 36, 0.15); }
  .stat-card:has(.stat-value.red) { border-color: rgba(248, 113, 113, 0.15); }

  /* ── Section Layout ── */
  .section {
    margin-bottom: 32px;
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-subtle);
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-bright);
    letter-spacing: -0.01em;
  }

  .section-title .icon {
    font-size: 14px;
    opacity: 0.7;
  }

  .section-count {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text3);
    font-weight: 400;
  }

  /* ── Collapsible Section ── */
  .section-collapsible .section-header {
    cursor: pointer;
    user-select: none;
    transition: background 0.15s;
    margin: 0 -8px 0;
    padding: 10px 8px;
    border-radius: var(--radius-sm);
    border-bottom: none;
  }
  .section-collapsible .section-header:hover {
    background: rgba(255,255,255,0.02);
  }

  .section-collapse-icon {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text3);
    transition: transform 0.2s;
    display: inline-block;
  }
  .section-collapsible.collapsed .section-collapse-icon {
    transform: rotate(-90deg);
  }

  .section-collapsible .section-body {
    overflow: hidden;
    transition: max-height 0.35s ease, opacity 0.25s ease;
    max-height: 5000px;
    opacity: 1;
    border-top: 1px solid var(--border-subtle);
    margin-top: 10px;
    padding-top: 14px;
  }
  .section-collapsible.collapsed .section-body {
    max-height: 0;
    opacity: 0;
    margin-top: 0;
    padding-top: 0;
    border-top: none;
  }

  /* ── Current Task ── */
  .task-panel {
    background: var(--surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius);
    padding: 16px 18px;
    margin-bottom: 10px;
    position: relative;
    transition: border-color 0.2s;
  }

  .task-panel.active {
    border-color: rgba(251, 191, 36, 0.25);
    background: linear-gradient(135deg, var(--surface) 0%, rgba(251, 191, 36, 0.02) 100%);
  }

  .task-panel.active::before {
    content: '';
    position: absolute;
    left: 0; top: 12px; bottom: 12px;
    width: 3px;
    background: var(--yellow);
    border-radius: 0 2px 2px 0;
  }

  .task-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .task-badge {
    font-family: var(--mono);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text3);
  }

  .task-badge.running {
    color: var(--yellow);
  }

  .task-elapsed {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--yellow);
    font-weight: 500;
  }

  .task-prompt {
    font-size: 13px;
    color: var(--text);
    margin-bottom: 10px;
    word-break: break-word;
    line-height: 1.5;
  }

  .task-meta {
    display: flex;
    gap: 16px;
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text3);
  }

  .task-meta-value { color: var(--text2); font-weight: 500; }

  .task-last-text {
    font-size: 12px;
    color: var(--text2);
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border-subtle);
    max-height: 52px;
    overflow: hidden;
    word-break: break-word;
    cursor: pointer;
    transition: max-height 0.3s ease;
    line-height: 1.5;
  }
  .task-last-text.expanded { max-height: 2000px; }

  .queue-item {
    background: var(--surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 12px;
  }

  .queue-item-msg {
    color: var(--text);
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .queue-item-wait {
    font-family: var(--mono);
    color: var(--text3);
    font-size: 10px;
    margin-left: 12px;
    white-space: nowrap;
  }

  /* ── Knowledge Journal (Primary) ── */
  .journal-filters {
    display: flex;
    gap: 5px;
    margin-bottom: 14px;
    flex-wrap: wrap;
  }

  .filter-chip {
    font-family: var(--mono);
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text2);
    padding: 4px 11px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 11px;
    transition: all 0.15s;
    letter-spacing: 0.01em;
  }
  .filter-chip:hover { border-color: var(--text2); color: var(--text); }
  .filter-chip.active {
    background: var(--accent-dim);
    border-color: rgba(94, 234, 212, 0.3);
    color: var(--accent);
    font-weight: 500;
  }

  .journal-grid {
    display: grid;
    gap: 8px;
  }

  .j-card {
    background: var(--surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius);
    padding: 16px 18px;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .j-card:hover {
    border-color: var(--border);
    background: var(--surface2);
  }

  /* Category accent stripe */
  .j-card::before {
    content: '';
    position: absolute;
    left: 0; top: 12px; bottom: 12px;
    width: 3px;
    border-radius: 0 2px 2px 0;
    transition: height 0.3s;
  }
  .j-card.cat-learning::before { background: var(--purple); }
  .j-card.cat-action::before { background: var(--accent); }
  .j-card.cat-issue::before { background: var(--red); }
  .j-card.cat-lesson::before { background: var(--yellow); }

  .j-meta {
    display: flex;
    align-items: center;
    gap: 7px;
    margin-bottom: 8px;
    flex-wrap: wrap;
  }

  .j-badge {
    font-family: var(--mono);
    display: inline-block;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .j-badge.learning { background: var(--purple-dim); color: var(--purple); }
  .j-badge.action { background: var(--accent-dim); color: var(--accent); }
  .j-badge.issue { background: var(--red-dim); color: var(--red); }
  .j-badge.lesson { background: var(--yellow-dim); color: var(--yellow); }

  .j-topic {
    font-family: var(--mono);
    display: inline-block;
    padding: 2px 7px;
    border-radius: 3px;
    font-size: 10px;
    background: var(--surface3);
    color: var(--text2);
  }

  /* Library reference chip in journal card */
  .j-lib-ref {
    font-family: var(--mono);
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 10px;
    background: var(--blue-dim);
    color: var(--blue);
    cursor: pointer;
    transition: all 0.15s;
    text-decoration: none;
  }
  .j-lib-ref:hover {
    background: rgba(96, 165, 250, 0.2);
    color: #93bbfc;
  }
  .j-lib-ref .lib-icon { font-size: 9px; }

  .j-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-bright);
    margin-bottom: 6px;
    line-height: 1.45;
    letter-spacing: -0.01em;
  }

  .j-summary {
    font-size: 12.5px;
    color: var(--text2);
    line-height: 1.7;
    max-height: 80px;
    overflow: hidden;
    transition: max-height 0.4s ease;
    cursor: pointer;
    word-break: break-word;
    position: relative;
  }
  .j-summary:not(.expanded)::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 28px;
    background: linear-gradient(to bottom, transparent, var(--surface));
    pointer-events: none;
  }
  .j-card:hover .j-summary:not(.expanded)::after {
    background: linear-gradient(to bottom, transparent, var(--surface2));
  }
  .j-summary.expanded { max-height: 8000px; }
  .j-summary.expanded::after { display: none; }

  .j-opinion {
    margin-top: 10px;
    padding: 10px 12px;
    background: var(--purple-dim);
    border-left: 2px solid rgba(167, 139, 250, 0.4);
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    font-size: 12px;
    color: var(--text);
    line-height: 1.6;
    display: none;
  }

  .j-opinion-label {
    font-family: var(--mono);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--purple);
    margin-bottom: 4px;
    font-weight: 500;
  }

  .j-summary.expanded ~ .j-opinion { display: block; }

  .j-links {
    margin-top: 8px;
    display: none;
    padding-top: 8px;
    border-top: 1px solid var(--border-subtle);
  }
  .j-summary.expanded ~ .j-links { display: block; }

  .j-links a {
    font-family: var(--mono);
    color: var(--blue);
    text-decoration: none;
    font-size: 11px;
    display: inline-block;
    margin-right: 14px;
    word-break: break-all;
    opacity: 0.8;
    transition: opacity 0.15s;
  }
  .j-links a:hover { opacity: 1; text-decoration: underline; }

  .j-toggle {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text3);
    cursor: pointer;
    margin-top: 6px;
    user-select: none;
    transition: color 0.15s;
    letter-spacing: 0.02em;
  }
  .j-toggle:hover { color: var(--accent); }

  /* ── Learning Report (Compact) ── */
  .l-card {
    background: var(--surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius);
    padding: 14px 16px;
    margin-bottom: 6px;
    transition: all 0.2s;
    position: relative;
  }
  .l-card:hover {
    border-color: var(--border);
    background: var(--surface2);
  }

  .l-card::before {
    content: '';
    position: absolute;
    left: 0; top: 10px; bottom: 10px;
    width: 3px;
    border-radius: 0 2px 2px 0;
    background: var(--purple);
    opacity: 0.5;
  }

  .l-time {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text3);
    margin-bottom: 4px;
    letter-spacing: 0.03em;
  }

  .l-what {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-bright);
    margin-bottom: 3px;
    line-height: 1.4;
  }

  .l-why {
    font-size: 12px;
    color: var(--text2);
    line-height: 1.5;
  }

  .l-detail {
    font-size: 12px;
    color: var(--text2);
    margin-top: 0;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.35s ease, margin-top 0.35s ease;
    line-height: 1.6;
  }
  .l-detail.expanded { max-height: 3000px; margin-top: 10px; }

  .l-detail-inner {
    padding-top: 10px;
    border-top: 1px solid var(--border-subtle);
  }

  .l-detail-section { margin-bottom: 8px; }

  .l-detail-label {
    font-family: var(--mono);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text3);
    margin-bottom: 3px;
  }

  .l-detail-content {
    color: var(--text);
    white-space: pre-wrap;
    word-break: break-word;
  }

  .l-detail-content code {
    font-family: var(--mono);
    background: var(--surface3);
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 11px;
  }

  .l-refs a {
    font-family: var(--mono);
    color: var(--blue);
    text-decoration: none;
    font-size: 11px;
    display: block;
    padding: 2px 0;
    word-break: break-all;
    opacity: 0.8;
  }
  .l-refs a:hover { opacity: 1; text-decoration: underline; }

  .l-toggle {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text3);
    cursor: pointer;
    margin-top: 5px;
    user-select: none;
    transition: color 0.15s;
  }
  .l-toggle:hover { color: var(--accent); }

  /* ── Filters (Timeline) ── */
  .filters-bar {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 14px;
    flex-wrap: wrap;
  }

  .filters-bar .divider {
    width: 1px;
    height: 16px;
    background: var(--border);
    margin: 0 4px;
  }

  .date-input {
    font-family: var(--mono);
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    transition: border-color 0.15s;
  }
  .date-input:focus { outline: none; border-color: var(--accent); }

  /* ── Timeline ── */
  .timeline {
    position: relative;
    padding-left: 110px;
  }

  .timeline::before {
    content: '';
    position: absolute;
    left: 99px;
    top: 0;
    bottom: 0;
    width: 1px;
    background: linear-gradient(to bottom, var(--border), var(--border-subtle));
  }

  .tl-entry {
    position: relative;
    padding: 7px 0 7px 16px;
    border-bottom: 1px solid var(--border-subtle);
    transition: background 0.15s;
  }
  .tl-entry:hover { background: rgba(255,255,255,0.01); }
  .tl-entry:last-child { border-bottom: none; }

  .tl-time {
    position: absolute;
    left: -110px;
    top: 9px;
    width: 90px;
    text-align: right;
    font-family: var(--mono);
    color: var(--text3);
    font-size: 11px;
    letter-spacing: 0.02em;
  }

  .tl-dot {
    position: absolute;
    left: -5px;
    top: 12px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: 2px solid var(--bg);
    z-index: 1;
  }
  .tl-dot.agent { background: var(--accent); }
  .tl-dot.user { background: var(--blue); }
  .tl-dot.system { background: var(--yellow); }

  .tl-action {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    margin-bottom: 2px;
  }

  .actor-tag {
    font-family: var(--mono);
    display: inline-block;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 9px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .actor-tag.agent { background: var(--accent-dim); color: var(--accent); }
  .actor-tag.user { background: var(--blue-dim); color: var(--blue); }
  .actor-tag.system { background: var(--yellow-dim); color: var(--yellow); }

  .action-name {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text);
  }
  .action-name.learning { color: var(--purple); }
  .action-name.memory { color: var(--yellow); }
  .action-name.telegram { color: var(--blue); }
  .action-name.loop { color: var(--text3); }
  .action-name.error { color: var(--red); }

  .tl-detail {
    color: var(--text2);
    font-size: 12px;
    overflow: hidden;
    max-height: 38px;
    transition: max-height 0.3s ease;
    cursor: pointer;
    word-break: break-word;
    line-height: 1.5;
    position: relative;
  }
  .tl-detail:not(.expanded)::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 20px;
    background: linear-gradient(to bottom, transparent, var(--bg));
    pointer-events: none;
  }
  .tl-detail.expanded { max-height: 3000px; }
  .tl-detail.expanded::after { display: none; }

  /* ── Cycles View ── */
  .cycle-group {
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius);
    margin-bottom: 6px;
    overflow: hidden;
    transition: border-color 0.15s;
  }
  .cycle-group:hover { border-color: var(--border); }

  .cycle-header {
    background: var(--surface);
    padding: 10px 16px;
    font-size: 12px;
    color: var(--text2);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.15s;
  }
  .cycle-header:hover { background: var(--surface2); }

  .cycle-label {
    font-family: var(--mono);
    font-weight: 600;
    color: var(--accent);
    font-size: 11px;
  }

  .cycle-time {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text3);
  }

  .cycle-result {
    max-width: 500px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 12px;
    color: var(--text2);
  }

  .cycle-body {
    display: none;
    border-top: 1px solid var(--border-subtle);
  }

  /* ── Empty & Loading States ── */
  .empty-state {
    text-align: center;
    padding: 48px 20px;
    color: var(--text3);
    font-size: 13px;
  }

  .loading {
    text-align: center;
    padding: 36px;
    color: var(--text3);
    font-family: var(--mono);
    font-size: 12px;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }
  .loading span { animation: pulse 2s ease-in-out infinite; }

  /* ── Scroll to Top ── */
  .scroll-top {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text2);
    width: 36px; height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s;
    backdrop-filter: blur(8px);
    z-index: 100;
  }
  .scroll-top:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-2px); }
  .scroll-top.visible { display: flex; }

  /* ── Library ── */
  .lib-toolbar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
  .lib-search { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 6px 10px; color: var(--text); font-family: var(--mono); font-size: 12px; width: 200px; outline: none; }
  .lib-search:focus { border-color: var(--accent); }
  .lib-tags { display: flex; gap: 4px; flex-wrap: wrap; flex: 1; }
  .lib-tag-chip { display: inline-block; padding: 2px 8px; background: var(--surface2); border-radius: 3px; font-size: 11px; font-family: var(--mono); color: var(--text2); cursor: pointer; border: 1px solid transparent; }
  .lib-tag-chip.active { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
  .lib-sort { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 4px 8px; color: var(--text2); font-family: var(--mono); font-size: 11px; outline: none; }
  .lib-card { background: var(--surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); padding: 10px 14px; margin-bottom: 6px; cursor: pointer; transition: border-color 0.15s; }
  .lib-card:hover { border-color: var(--accent); }
  .lib-card-title { color: var(--text-bright); font-weight: 500; font-size: 13px; margin-bottom: 4px; }
  .lib-card-meta { font-family: var(--mono); font-size: 11px; color: var(--text3); display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  .lib-card-meta .cited { color: var(--accent); font-weight: 500; }
  .lib-card-tags { display: flex; gap: 4px; margin-top: 4px; }
  .lib-card-tag { font-size: 10px; padding: 1px 6px; background: var(--surface2); border-radius: 3px; color: var(--text2); font-family: var(--mono); }
  .lib-mode { font-size: 10px; padding: 1px 6px; border-radius: 3px; font-family: var(--mono); }
  .lib-mode.full { background: var(--accent-dim); color: var(--accent); }
  .lib-mode.excerpt { background: var(--yellow-dim); color: var(--yellow); }
  .lib-mode.metadata-only { background: var(--surface2); color: var(--text3); }
  .lib-detail-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 100; display: flex; justify-content: center; align-items: flex-start; padding: 40px 20px; overflow-y: auto; }
  .lib-detail-panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); max-width: 800px; width: 100%; padding: 20px; max-height: calc(100vh - 80px); overflow-y: auto; }
  .lib-detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .lib-back { background: none; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 4px 12px; color: var(--text2); cursor: pointer; font-family: var(--mono); font-size: 12px; }
  .lib-back:hover { border-color: var(--accent); color: var(--accent); }
  .lib-original { font-family: var(--mono); font-size: 11px; color: var(--blue); text-decoration: none; }
  .lib-original:hover { text-decoration: underline; }
  .lib-detail-title { font-size: 18px; font-weight: 600; color: var(--text-bright); margin-bottom: 8px; }
  .lib-detail-meta { font-family: var(--mono); font-size: 11px; color: var(--text3); margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap; }
  .lib-cited-by { margin-bottom: 16px; }
  .lib-cited-by-title { font-family: var(--mono); font-size: 10px; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text3); margin-bottom: 6px; }
  .lib-cited-by-item { font-size: 12px; color: var(--text2); padding: 2px 0; font-family: var(--mono); }
  .lib-content-body { font-size: 13px; line-height: 1.7; color: var(--text); border-top: 1px solid var(--border-subtle); padding-top: 16px; white-space: pre-wrap; word-break: break-word; }

  /* ── Decision Timeline ── */
  .decision-entry {
    display: flex;
    gap: 12px;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border-subtle);
    font-size: 12px;
  }
  .decision-entry:last-child { border-bottom: none; }
  .decision-time { color: var(--text3); font-family: var(--mono); min-width: 50px; }
  .decision-mode {
    font-family: var(--mono);
    font-size: 11px;
    padding: 1px 6px;
    border-radius: 3px;
    background: var(--accent-dim);
    color: var(--accent);
    min-width: 80px;
    text-align: center;
  }
  .decision-text { color: var(--text); flex: 1; }
  .decision-score {
    font-family: var(--mono);
    font-size: 11px;
    min-width: 20px;
    text-align: right;
  }
  .score-high { color: var(--accent); }
  .score-mid { color: var(--yellow); }
  .score-low { color: var(--red); }

  /* ── Context Health ── */
  .ctx-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
    padding: 12px;
  }
  .ctx-card {
    background: var(--surface2);
    border-radius: var(--radius-sm);
    padding: 10px 12px;
  }
  .ctx-card-label {
    font-size: 11px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }
  .ctx-card-value {
    font-family: var(--mono);
    font-size: 16px;
    color: var(--text-bright);
  }
  .ctx-sections {
    padding: 0 12px 12px;
  }
  .ctx-bar-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 3px 0;
    font-size: 11px;
  }
  .ctx-bar-label {
    min-width: 100px;
    color: var(--text2);
    font-family: var(--mono);
  }
  .ctx-bar {
    flex: 1;
    height: 6px;
    background: var(--surface3);
    border-radius: 3px;
    overflow: hidden;
  }
  .ctx-bar-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 3px;
    transition: width 0.3s ease;
  }
  .ctx-bar-value {
    min-width: 50px;
    text-align: right;
    font-family: var(--mono);
    color: var(--text3);
  }

  /* ── Responsive ── */
  @media (max-width: 768px) {
    .container { padding: 16px; }
    .status-grid { grid-template-columns: repeat(2, 1fr); }
    .status-grid > :last-child { grid-column: span 2; }
    .stat-value { font-size: 18px; }
    .timeline { padding-left: 80px; }
    .timeline::before { left: 69px; }
    .tl-time { left: -80px; width: 60px; font-size: 10px; }
    .tl-dot { left: -5px; }
    .j-title { font-size: 13px; }
    .today-bar { gap: 4px; }
    .today-chip { font-size: 10px; padding: 4px 8px; }
  }

  /* ── Animations ── */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .section {
    animation: fadeIn 0.4s ease both;
  }
  .section:nth-child(2) { animation-delay: 0.05s; }
  .section:nth-child(3) { animation-delay: 0.1s; }
  .section:nth-child(4) { animation-delay: 0.15s; }
  .section:nth-child(5) { animation-delay: 0.2s; }
  .section:nth-child(6) { animation-delay: 0.25s; }
  .section:nth-child(7) { animation-delay: 0.3s; }
  .section:nth-child(8) { animation-delay: 0.35s; }
  .section:nth-child(9) { animation-delay: 0.4s; }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-left">
      <h1>Kuro<span>Dashboard</span></h1>
      <span class="header-version" id="instanceId">--</span>
    </div>
    <div class="header-controls">
      <div class="status-indicator">
        <span class="status-dot ok" id="statusDot"></span>
        <span id="refreshInfo">--</span>
      </div>
    </div>
  </header>

  <!-- Today Summary Bar -->
  <div class="today-bar" id="todayBar">
    <div class="today-chip highlight">
      <span class="chip-icon">&#9670;</span>
      <span>Journal</span>
      <span class="chip-value" id="todayJournal">--</span>
    </div>
    <div class="today-chip">
      <span class="chip-icon">&#128218;</span>
      <span>Library</span>
      <span class="chip-value" id="todayLibrary">--</span>
    </div>
    <div class="today-chip">
      <span class="chip-icon">&#9472;</span>
      <span>Behaviors</span>
      <span class="chip-value" id="todayBehaviors">--</span>
    </div>
    <div class="today-chip">
      <span class="chip-icon">&#9654;</span>
      <span>Decisions</span>
      <span class="chip-value" id="todayDecisions">--</span>
    </div>
    <span style="flex: 1;"></span>
    <input type="date" class="date-input" id="dateInput">
  </div>

  <!-- Status Grid -->
  <div class="status-grid" id="statusGrid">
    <div class="stat-card">
      <div class="stat-label">Uptime</div>
      <div class="stat-value" id="uptime">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Claude</div>
      <div class="stat-value" id="claudeStatus">--</div>
      <div class="stat-detail" id="claudeDetail"></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Loop</div>
      <div class="stat-value" id="loopStatus">--</div>
      <div class="stat-detail" id="loopDetail"></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Telegram</div>
      <div class="stat-value" id="telegramStatus">--</div>
      <div class="stat-detail" id="telegramDetail"></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Behaviors</div>
      <div class="stat-value" id="behaviorCount">--</div>
      <div class="stat-detail" id="behaviorBreakdown"></div>
    </div>
  </div>

  <!-- Current Activity -->
  <div class="section" id="taskSection">
    <div class="section-header">
      <div class="section-title"><span class="icon">&#9656;</span> Current Activity</div>
      <span class="section-count" id="queueCount"></span>
    </div>
    <div id="taskContent">
      <div class="task-panel">
        <div class="task-badge">Claude</div>
        <div style="color: var(--text3); font-size: 12px; margin-top: 4px;">Idle — waiting for tasks</div>
      </div>
    </div>
  </div>

  <!-- Knowledge Journal (PRIMARY — most prominent) -->
  <div class="section" id="journalSection">
    <div class="section-header">
      <div class="section-title"><span class="icon">&#9670;</span> Knowledge Journal</div>
      <span class="section-count" id="journalCount">--</span>
    </div>
    <div class="journal-filters" id="journalFilters">
      <button class="filter-chip active" data-jcat="all">All</button>
      <button class="filter-chip" data-jcat="learning">Learning</button>
      <button class="filter-chip" data-jcat="action">Action</button>
      <button class="filter-chip" data-jcat="issue">Issue</button>
      <button class="filter-chip" data-jcat="lesson">Lesson</button>
    </div>
    <div class="journal-grid" id="journalContent">
      <div class="loading"><span>Loading...</span></div>
    </div>
  </div>

  <!-- Library (RIGHT AFTER Journal — linked) -->
  <div class="section" id="librarySection">
    <div class="section-header">
      <div class="section-title"><span class="icon">&#128218;</span> Library</div>
      <span class="section-count" id="libraryCount">--</span>
    </div>
    <div class="lib-toolbar">
      <input type="text" class="lib-search" id="libSearch" placeholder="Search title, tags...">
      <div class="lib-tags" id="libTags"></div>
      <select class="lib-sort" id="libSort">
        <option value="cited">Most Cited</option>
        <option value="date">Most Recent</option>
      </select>
    </div>
    <div id="libraryContent">
      <div class="loading"><span>Loading...</span></div>
    </div>
    <div class="lib-detail-overlay" id="libDetailOverlay" style="display:none;">
      <div class="lib-detail-panel">
        <div class="lib-detail-header">
          <button class="lib-back" id="libBack">&larr; Back</button>
          <a class="lib-original" id="libOriginalLink" target="_blank" rel="noopener">Open Original</a>
        </div>
        <div id="libDetailContent"></div>
      </div>
    </div>
  </div>

  <!-- Activity Log -->
  <div class="section" id="learningSection">
    <div class="section-header">
      <div class="section-title"><span class="icon">&#9679;</span> Activity Log</div>
      <span class="section-count" id="learningCount">--</span>
    </div>
    <div id="learningContent">
      <div class="loading"><span>Loading...</span></div>
    </div>
  </div>

  <!-- Behavior Timeline (COLLAPSIBLE) -->
  <div class="section section-collapsible collapsed" id="behaviorSection">
    <div class="section-header" onclick="toggleSection('behaviorSection')">
      <div class="section-title">
        <span class="icon">&#9472;</span> Behavior Timeline
        <span class="section-collapse-icon">&#9660;</span>
      </div>
    </div>
    <div class="section-body">
      <div class="filters-bar">
        <button class="filter-chip active" data-actor="all">All</button>
        <button class="filter-chip" data-actor="agent">Agent</button>
        <button class="filter-chip" data-actor="user">User</button>
        <button class="filter-chip" data-actor="system">System</button>
        <div class="divider"></div>
        <button class="filter-chip active" data-view="timeline">Timeline</button>
        <button class="filter-chip" data-view="cycles">Cycles</button>
      </div>
      <div id="content">
        <div class="loading"><span>Loading...</span></div>
      </div>
    </div>
  </div>

  <!-- Decision Timeline (COLLAPSIBLE) -->
  <div class="section section-collapsible collapsed" id="decisionSection">
    <div class="section-header" onclick="toggleSection('decisionSection')">
      <div class="section-title">
        <span class="icon">&#9654;</span> Decision Timeline
        <span class="section-collapse-icon">&#9660;</span>
        <span class="section-count" id="decisionCount">--</span>
      </div>
    </div>
    <div class="section-body">
      <div id="decisionContent">
        <div class="loading"><span>Loading...</span></div>
      </div>
    </div>
  </div>

  <!-- Context Health (COLLAPSIBLE) -->
  <div class="section section-collapsible collapsed" id="contextSection">
    <div class="section-header" onclick="toggleSection('contextSection')">
      <div class="section-title">
        <span class="icon">&#9608;</span> Context Health
        <span class="section-collapse-icon">&#9660;</span>
      </div>
    </div>
    <div class="section-body">
      <div id="contextContent">
        <div class="loading"><span>Loading...</span></div>
      </div>
    </div>
  </div>

</div>

<button class="scroll-top" id="scrollTop" title="Scroll to top">&#8593;</button>

<script>
const API = window.location.origin;
let currentActor = 'all';
let currentView = 'timeline';
let currentDate = new Date().toISOString().split('T')[0];
let lastUpdate = null;
let allBehaviors = [];
let allJournalEntries = [];
let currentJournalCat = 'all';

// Library data — used for Journal↔Library linking
let libraryData = [];
let libUrlMap = {};   // url → CatalogEntry
let libCitedMap = {};
let libActiveTag = '';

// Init
document.getElementById('dateInput').value = currentDate;

// ── Section Collapse ──

function toggleSection(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.toggle('collapsed');
}

// ── Event Listeners ──

document.querySelectorAll('.filter-chip[data-jcat]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-chip[data-jcat]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentJournalCat = btn.dataset.jcat;
    renderJournal(allJournalEntries);
  });
});

document.querySelectorAll('.filter-chip[data-actor]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-chip[data-actor]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentActor = btn.dataset.actor;
    render();
  });
});

document.querySelectorAll('.filter-chip[data-view]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-chip[data-view]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentView = btn.dataset.view;
    render();
  });
});

document.getElementById('dateInput').addEventListener('change', (e) => {
  currentDate = e.target.value;
  fetchAll();
});

// Scroll to top
const scrollBtn = document.getElementById('scrollTop');
window.addEventListener('scroll', () => {
  scrollBtn.classList.toggle('visible', window.scrollY > 300);
});
scrollBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

// ── Helpers ──

function formatUptime(seconds) {
  const d = Math.floor(seconds / 86400);
  const h = Math.floor((seconds % 86400) / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  if (d > 0) return d + 'd ' + h + 'h';
  if (h > 0) return h + 'h ' + m + 'm';
  return m + 'm';
}

function formatTime(ts) {
  const d = new Date(ts);
  return d.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function classifyAction(action) {
  if (action.includes('loop.cycle')) return 'loop';
  if (action.includes('action.') || action.includes('claude.call')) return 'learning';
  if (action.includes('memory.') || action.includes('task.')) return 'memory';
  if (action.includes('telegram.')) return 'telegram';
  if (action.includes('error') || action.includes('diag')) return 'error';
  return '';
}

function escapeHtml(str) {
  const el = document.createElement('span');
  el.textContent = str;
  return el.innerHTML;
}

function formatMarkdown(str) {
  let out = escapeHtml(str);
  out = out.replace(/`([^`]+)`/g, '<code>$1</code>');
  out = out.replace(/\*\*(.+?)\*\*/g, '<strong style="color:var(--text-bright)">$1</strong>');
  out = out.replace(/\n/g, '<br>');
  return out;
}

// ── Journal↔Library URL matching ──

function buildLibUrlMap() {
  libUrlMap = {};
  for (const entry of libraryData) {
    if (entry.url) {
      // Normalize URL for matching: strip protocol, trailing slash
      const normalized = entry.url.replace(/^https?:\/\//, '').replace(/\/$/, '');
      libUrlMap[normalized] = entry;
      // Also store the raw url
      libUrlMap[entry.url] = entry;
    }
  }
}

function findLibraryMatch(urls) {
  if (!urls || urls.length === 0) return null;
  for (const url of urls) {
    const normalized = url.replace(/^https?:\/\//, '').replace(/\/$/, '');
    if (libUrlMap[normalized]) return libUrlMap[normalized];
    if (libUrlMap[url]) return libUrlMap[url];
    // Partial match: check if any library URL starts with journal URL's domain+path
    for (const libEntry of libraryData) {
      if (!libEntry.url) continue;
      const libNorm = libEntry.url.replace(/^https?:\/\//, '').replace(/\/$/, '');
      if (normalized.startsWith(libNorm) || libNorm.startsWith(normalized)) {
        return libEntry;
      }
    }
  }
  return null;
}

// ── Data Fetching ──

// ── Decision Timeline Rendering ──

function renderDecisions(entries) {
  const container = document.getElementById('decisionContent');
  const countEl = document.getElementById('decisionCount');

  const withDecision = entries.filter(e => e.decision || e.modeTag);
  countEl.textContent = withDecision.length;

  // Update today bar
  document.getElementById('todayDecisions').textContent = withDecision.length;

  if (withDecision.length === 0) {
    container.innerHTML = '<div class="empty-state">No decisions recorded today.</div>';
    return;
  }

  let html = '';
  for (const e of withDecision.slice(-30).reverse()) {
    const time = formatTime(e.timestamp);
    const mode = e.modeTag || e.route || '?';
    const text = e.decision || e.what || '(no trace)';
    const score = e.observabilityScore ?? 0;
    const scoreClass = score >= 4 ? 'score-high' : score >= 2 ? 'score-mid' : 'score-low';

    html += '<div class="decision-entry">';
    html += '<span class="decision-time">' + time + '</span>';
    html += '<span class="decision-mode">' + escapeHtml(mode) + '</span>';
    html += '<span class="decision-text">' + escapeHtml(text.slice(0, 200)) + '</span>';
    html += '<span class="decision-score ' + scoreClass + '">' + score + '/6</span>';
    html += '</div>';
  }

  container.innerHTML = html;
}

// ── Context Health Rendering ──

function renderContextHealth(data) {
  const container = document.getElementById('contextContent');
  const summary = data.summary;

  if (!summary) {
    container.innerHTML = '<div class="empty-state">No context checkpoints today.</div>';
    return;
  }

  let html = '<div class="ctx-summary">';
  html += '<div class="ctx-card"><div class="ctx-card-label">Checkpoints</div><div class="ctx-card-value">' + summary.checkpointCount + '</div></div>';
  html += '<div class="ctx-card"><div class="ctx-card-label">Avg Context</div><div class="ctx-card-value">' + (summary.avgContextLength > 1000 ? Math.round(summary.avgContextLength / 1000) + 'K' : summary.avgContextLength) + ' chars</div></div>';

  const topicCount = Object.keys(summary.topicUtility || {}).length;
  html += '<div class="ctx-card"><div class="ctx-card-label">Topics Loaded</div><div class="ctx-card-value">' + topicCount + '</div></div>';
  html += '</div>';

  // Section size bars
  const sections = summary.sections || {};
  const sectionNames = Object.keys(sections);
  if (sectionNames.length > 0) {
    const maxChars = Math.max(...sectionNames.map(n => sections[n].avgChars));
    html += '<div class="ctx-sections">';
    const sorted = sectionNames.sort((a, b) => sections[b].avgChars - sections[a].avgChars);
    for (const name of sorted) {
      const s = sections[name];
      const pct = maxChars > 0 ? Math.round((s.avgChars / maxChars) * 100) : 0;
      const sizeStr = s.avgChars > 1000 ? Math.round(s.avgChars / 1000) + 'K' : s.avgChars;
      html += '<div class="ctx-bar-row">';
      html += '<span class="ctx-bar-label">' + escapeHtml(name) + '</span>';
      html += '<div class="ctx-bar"><div class="ctx-bar-fill" style="width:' + pct + '%"></div></div>';
      html += '<span class="ctx-bar-value">' + sizeStr + '</span>';
      html += '</div>';
    }
    html += '</div>';
  }

  // Topic utility
  const topicUtility = summary.topicUtility || {};
  const topicNames = Object.keys(topicUtility);
  if (topicNames.length > 0) {
    html += '<div style="padding: 8px 12px; border-top: 1px solid var(--border-subtle);">';
    html += '<div style="font-size: 11px; color: var(--text3); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Topic Load Frequency</div>';
    const sortedTopics = topicNames.sort((a, b) => topicUtility[b] - topicUtility[a]);
    for (const t of sortedTopics) {
      html += '<span style="display:inline-block;margin:2px 4px;padding:2px 8px;background:var(--surface2);border-radius:3px;font-size:11px;font-family:var(--mono);">' + escapeHtml(t) + ' <span style="color:var(--accent);">' + topicUtility[t] + '</span></span>';
    }
    html += '</div>';
  }

  container.innerHTML = html;
}

async function fetchAll() {
  try {
    const [statusRes, behaviorsRes, learningRes, journalRes, cognitionRes, contextRes] = await Promise.all([
      fetch(API + '/status'),
      fetch(API + '/api/dashboard/behaviors?date=' + currentDate + '&limit=500'),
      fetch(API + '/api/dashboard/learning?date=' + currentDate),
      fetch(API + '/api/dashboard/journal?date=' + currentDate),
      fetch(API + '/api/dashboard/cognition?date=' + currentDate).catch(() => null),
      fetch(API + '/api/dashboard/context?date=' + currentDate).catch(() => null),
    ]);

    for (const [name, res] of [['status', statusRes], ['behaviors', behaviorsRes], ['learning', learningRes], ['journal', journalRes]]) {
      if (!res.ok) throw new Error(name + ' API returned ' + res.status);
    }

    const status = await statusRes.json();
    const behaviors = await behaviorsRes.json();
    const learning = await learningRes.json();
    const journal = await journalRes.json();
    const cognition = cognitionRes?.ok ? await cognitionRes.json() : { entries: [] };
    const contextData = contextRes?.ok ? await contextRes.json() : { entries: [], summary: null };

    updateStatus(status);
    allBehaviors = behaviors.entries || [];
    allJournalEntries = journal.entries || [];

    // Update today summary bar
    document.getElementById('todayJournal').textContent = allJournalEntries.length;
    document.getElementById('todayBehaviors').textContent = allBehaviors.length;

    renderLearning(learning.entries || []);
    renderJournal(allJournalEntries);
    renderDecisions(cognition.entries || []);
    renderContextHealth(contextData);
    render();

    lastUpdate = new Date();
    document.getElementById('refreshInfo').textContent = formatTime(lastUpdate.toISOString());
    document.getElementById('statusDot').className = 'status-dot ok';
  } catch (err) {
    console.error('Fetch error:', err);
    document.getElementById('statusDot').className = 'status-dot error';
    document.getElementById('refreshInfo').textContent = 'Error';
  }
}

// ── Status Update ──

function updateStatus(s) {
  document.getElementById('instanceId').textContent = s.instance || '--';
  document.getElementById('uptime').textContent = formatUptime(s.uptime);

  // Claude
  const claudeEl = document.getElementById('claudeStatus');
  const claudeDetail = document.getElementById('claudeDetail');
  if (s.claude.busy) {
    claudeEl.textContent = 'Busy';
    claudeEl.className = 'stat-value yellow';
    const task = s.claude.currentTask;
    claudeDetail.textContent = task?.prompt ? task.prompt.slice(0, 50) + '...' : '';
  } else {
    claudeEl.textContent = 'Idle';
    claudeEl.className = 'stat-value green';
    const q = s.claude.queue;
    claudeDetail.textContent = q && q.size > 0 ? q.size + ' queued' : '';
  }

  // Loop
  const loopEl = document.getElementById('loopStatus');
  const loopDetail = document.getElementById('loopDetail');
  if (s.loop.enabled) {
    loopEl.textContent = s.loop.paused ? 'Paused' : 'Active';
    loopEl.className = 'stat-value ' + (s.loop.paused ? 'yellow' : 'green');
    loopDetail.textContent = '#' + (s.loop.cycleCount || 0);
  } else {
    loopEl.textContent = 'Off';
    loopEl.className = 'stat-value';
    loopDetail.textContent = '';
  }

  // Telegram
  const tgEl = document.getElementById('telegramStatus');
  const tgDetail = document.getElementById('telegramDetail');
  if (s.telegram.connected) {
    const n = s.telegram.notifications;
    tgEl.textContent = 'Online';
    tgEl.className = 'stat-value green';
    tgDetail.textContent = n.sent + ' sent / ' + n.failed + ' fail';
  } else {
    tgEl.textContent = 'Offline';
    tgEl.className = 'stat-value red';
    tgDetail.textContent = '';
  }

  renderTaskSection(s.claude);
}

// ── Task Section ──

function renderTaskSection(claude) {
  const container = document.getElementById('taskContent');
  const queueCountEl = document.getElementById('queueCount');
  const task = claude.currentTask;
  const queue = claude.queue;

  let html = '';

  if (claude.busy && task) {
    const elapsed = task.elapsed;
    const elapsedStr = elapsed > 60
      ? Math.floor(elapsed / 60) + 'm ' + (elapsed % 60) + 's'
      : elapsed + 's';

    html += '<div class="task-panel active">';
    html += '  <div class="task-header">';
    html += '    <div class="task-badge running">Running</div>';
    html += '    <div class="task-elapsed">' + elapsedStr + '</div>';
    html += '  </div>';
    html += '  <div class="task-prompt">' + escapeHtml(task.prompt.slice(0, 200)) + (task.prompt.length > 200 ? '...' : '') + '</div>';
    html += '  <div class="task-meta">';
    html += '    <span>Tools: <span class="task-meta-value">' + task.toolCalls + '</span></span>';
    if (task.lastTool) {
      html += '    <span>Last: <span class="task-meta-value">' + escapeHtml(task.lastTool) + '</span></span>';
    }
    html += '  </div>';
    if (task.lastText) {
      html += '  <div class="task-last-text" onclick="this.classList.toggle(\'expanded\')">' + escapeHtml(task.lastText.slice(0, 500)) + '</div>';
    }
    html += '</div>';
  } else {
    html += '<div class="task-panel">';
    html += '  <div class="task-badge">Claude</div>';
    html += '  <div style="color: var(--text3); font-size: 12px; margin-top: 4px;">Idle — waiting for tasks</div>';
    html += '</div>';
  }

  // Queue
  if (queue && queue.size > 0) {
    queueCountEl.textContent = queue.size + ' queued';
    html += '<div style="margin-top: 8px;">';
    html += '  <div style="font-family:var(--mono);font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px;">Queue (' + queue.size + '/' + queue.max + ')</div>';
    for (const item of (queue.items || [])) {
      const waitStr = item.waited > 60
        ? Math.floor(item.waited / 60) + 'm ' + (item.waited % 60) + 's'
        : item.waited + 's';
      html += '<div class="queue-item">';
      html += '  <div class="queue-item-msg">' + escapeHtml(item.message) + '</div>';
      html += '  <div class="queue-item-wait">' + waitStr + '</div>';
      html += '</div>';
    }
    html += '</div>';
  } else {
    queueCountEl.textContent = '';
  }

  container.innerHTML = html;
}

// ── Journal Rendering ──

const catLabels = { learning: 'Learning', action: 'Action', issue: 'Issue', lesson: 'Lesson' };
const topicLabels = {
  'agent-architecture': 'Agent',
  'cognitive-science': 'Cognition',
  'creative-arts': 'Creative',
  'design-philosophy': 'Design',
  'social-culture': 'Social',
};

function renderJournal(entries) {
  const container = document.getElementById('journalContent');
  const countEl = document.getElementById('journalCount');

  const filtered = currentJournalCat === 'all'
    ? entries
    : entries.filter(e => e.category === currentJournalCat);

  countEl.textContent = filtered.length + ' / ' + entries.length;

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state">No knowledge entries for this date.</div>';
    return;
  }

  let html = '';
  for (let i = 0; i < filtered.length; i++) {
    const e = filtered[i];
    const cat = e.category || 'learning';
    const topicShort = topicLabels[e.topic] || e.topic;
    const jid = 'j-' + i;

    // Check for library match
    const libMatch = findLibraryMatch(e.urls);

    html += '<div class="j-card cat-' + cat + '">';

    html += '  <div class="j-meta">';
    html += '    <span class="j-badge ' + cat + '">' + (catLabels[cat] || cat) + '</span>';
    html += '    <span class="j-topic">' + escapeHtml(topicShort) + '</span>';
    if (libMatch) {
      html += '    <span class="j-lib-ref" onclick="showLibraryDetail(\'' + escapeHtml(libMatch.id) + '\')" title="View in Library: ' + escapeHtml(libMatch.title) + '">';
      html += '      <span class="lib-icon">&#128218;</span> ' + escapeHtml(libMatch.title.slice(0, 30)) + (libMatch.title.length > 30 ? '...' : '');
      html += '    </span>';
    }
    html += '  </div>';

    html += '  <div class="j-title">' + escapeHtml(e.title) + '</div>';

    html += '  <div class="j-summary" id="' + jid + '" onclick="toggleJournal(\'' + jid + '\')">' + formatMarkdown(e.summary) + '</div>';

    if (e.opinion) {
      html += '  <div class="j-opinion">';
      html += '    <div class="j-opinion-label">My Take</div>';
      html += '    ' + formatMarkdown(e.opinion);
      html += '  </div>';
    }

    if (e.urls && e.urls.length > 0) {
      html += '  <div class="j-links">';
      for (const url of e.urls) {
        const display = url.replace(/^https?:\/\//, '').slice(0, 60);
        html += '    <a href="' + escapeHtml(url) + '" target="_blank" rel="noopener">' + escapeHtml(display) + '</a>';
      }
      html += '  </div>';
    }

    html += '  <div class="j-toggle" onclick="toggleJournal(\'' + jid + '\')">+ more</div>';
    html += '</div>';
  }

  container.innerHTML = html;
}

function toggleJournal(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.toggle('expanded');
  const card = el.closest('.j-card');
  if (card) {
    const hint = card.querySelector('.j-toggle');
    if (hint) hint.textContent = el.classList.contains('expanded') ? '- less' : '+ more';
  }
}

// ── Learning Report Rendering ──

function renderLearning(entries) {
  const container = document.getElementById('learningContent');
  const countEl = document.getElementById('learningCount');
  countEl.textContent = entries.length + ' today';

  if (entries.length === 0) {
    container.innerHTML = '<div class="empty-state">No activity log entries today.</div>';
    return;
  }

  let html = '';
  for (const entry of entries) {
    const time = formatTime(entry.timestamp);
    const id = 'lc-' + entry.timestamp.replace(/[^0-9]/g, '');
    const hasDetail = entry.changed || entry.verified || (entry.urls && entry.urls.length > 0) || entry.full;

    html += '<div class="l-card">';
    html += '  <div class="l-time">' + time + '</div>';
    html += '  <div class="l-what">' + escapeHtml(entry.what) + '</div>';
    if (entry.why) {
      html += '  <div class="l-why">' + escapeHtml(entry.why) + '</div>';
    }

    if (hasDetail) {
      html += '  <div class="l-detail" id="' + id + '">';
      html += '    <div class="l-detail-inner">';

      if (entry.changed) {
        html += '      <div class="l-detail-section">';
        html += '        <div class="l-detail-label">Changed</div>';
        html += '        <div class="l-detail-content">' + formatMarkdown(entry.changed) + '</div>';
        html += '      </div>';
      }

      if (entry.verified) {
        html += '      <div class="l-detail-section">';
        html += '        <div class="l-detail-label">Verified</div>';
        html += '        <div class="l-detail-content">' + formatMarkdown(entry.verified) + '</div>';
        html += '      </div>';
      }

      if (entry.urls && entry.urls.length > 0) {
        html += '      <div class="l-refs">';
        html += '        <div class="l-detail-label">References</div>';
        for (const url of entry.urls) {
          const display = url.replace(/^https?:\/\//, '').slice(0, 80);
          html += '        <a href="' + escapeHtml(url) + '" target="_blank" rel="noopener">' + escapeHtml(display) + '</a>';
        }
        html += '      </div>';
      }

      html += '    </div>';
      html += '  </div>';
      html += '  <div class="l-toggle" onclick="toggleLearningDetail(\'' + id + '\', this)">+ details</div>';
    }

    html += '</div>';
  }

  container.innerHTML = html;
}

function toggleLearningDetail(id, toggleEl) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.toggle('expanded');
  toggleEl.textContent = el.classList.contains('expanded') ? '- hide' : '+ details';
}

// ── Behavior Timeline ──

function render() {
  let filtered = allBehaviors;
  if (currentActor !== 'all') {
    filtered = filtered.filter(e => e.data.actor === currentActor);
  }

  const agents = allBehaviors.filter(e => e.data.actor === 'agent').length;
  const users = allBehaviors.filter(e => e.data.actor === 'user').length;
  const systems = allBehaviors.filter(e => e.data.actor === 'system').length;
  document.getElementById('behaviorCount').textContent = allBehaviors.length;
  document.getElementById('behaviorBreakdown').textContent =
    'agent:' + agents + '  user:' + users + '  sys:' + systems;

  const container = document.getElementById('content');

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state">No behaviors found for this date.</div>';
    return;
  }

  if (currentView === 'cycles') {
    renderCycles(container, filtered);
  } else {
    renderTimeline(container, filtered);
  }
}

function renderTimeline(container, entries) {
  let html = '<div class="timeline">';

  for (const entry of entries) {
    const actor = entry.data.actor;
    const action = entry.data.action;
    const detail = entry.data.detail || '';
    const actionClass = classifyAction(action);
    const time = formatTime(entry.timestamp);

    html += '<div class="tl-entry">';
    html += '  <div class="tl-time">' + time + '</div>';
    html += '  <div class="tl-dot ' + actor + '"></div>';
    html += '  <div class="tl-action">';
    html += '    <span class="actor-tag ' + actor + '">' + actor + '</span>';
    html += '    <span class="action-name ' + actionClass + '">' + escapeHtml(action) + '</span>';
    html += '  </div>';
    if (detail) {
      html += '  <div class="tl-detail" onclick="this.classList.toggle(\'expanded\')">' + escapeHtml(detail) + '</div>';
    }
    html += '</div>';
  }

  html += '</div>';
  container.innerHTML = html;
}

function renderCycles(container, entries) {
  const cycles = [];
  let current = null;

  for (const entry of entries) {
    const action = entry.data.action;

    if (action === 'loop.cycle.start') {
      current = {
        number: entry.data.detail || '?',
        start: entry.timestamp,
        end: null,
        result: '',
        entries: [entry],
      };
    } else if (action === 'loop.cycle.end' && current) {
      current.end = entry.timestamp;
      current.result = entry.data.detail || '';
      current.entries.push(entry);
      cycles.push(current);
      current = null;
    } else if (current) {
      current.entries.push(entry);
    } else {
      if (cycles.length === 0 || cycles[cycles.length - 1].number !== 'outside') {
        cycles.push({ number: 'outside', start: entry.timestamp, end: entry.timestamp, result: '', entries: [entry] });
      } else {
        cycles[cycles.length - 1].entries.push(entry);
        cycles[cycles.length - 1].end = entry.timestamp;
      }
    }
  }

  if (current) {
    current.result = '(in progress)';
    cycles.push(current);
  }

  let html = '';

  for (const cycle of cycles) {
    const duration = cycle.end
      ? Math.round((new Date(cycle.end) - new Date(cycle.start)) / 1000)
      : '...';
    const label = cycle.number === 'outside'
      ? 'Outside'
      : 'Cycle ' + cycle.number.replace('#', '');
    const durationStr = typeof duration === 'number'
      ? (duration > 60 ? Math.floor(duration / 60) + 'm ' + (duration % 60) + 's' : duration + 's')
      : duration;

    const cycleId = 'cy-' + cycle.start.replace(/[^0-9]/g, '');

    html += '<div class="cycle-group">';
    html += '  <div class="cycle-header" onclick="toggleCycle(\'' + cycleId + '\')">';
    html += '    <span><span class="cycle-label">' + label + '</span> <span class="cycle-time">' + formatTime(cycle.start) + ' &middot; ' + durationStr + '</span></span>';
    html += '    <span class="cycle-result">' + escapeHtml(cycle.result.slice(0, 80)) + '</span>';
    html += '  </div>';
    html += '  <div class="cycle-body" id="' + cycleId + '">';
    html += '    <div class="timeline" style="margin: 8px 0 8px 12px; padding-left: 100px;">';
    html += '      <div style="position:absolute;left:89px;top:0;bottom:0;width:1px;background:var(--border-subtle);"></div>';

    for (const entry of cycle.entries) {
      const actor = entry.data.actor;
      const action = entry.data.action;
      const detail = entry.data.detail || '';
      const actionClass = classifyAction(action);
      const time = formatTime(entry.timestamp);

      html += '<div class="tl-entry">';
      html += '  <div class="tl-time">' + time + '</div>';
      html += '  <div class="tl-dot ' + actor + '"></div>';
      html += '  <div class="tl-action">';
      html += '    <span class="actor-tag ' + actor + '">' + actor + '</span>';
      html += '    <span class="action-name ' + actionClass + '">' + escapeHtml(action) + '</span>';
      html += '  </div>';
      if (detail) {
        html += '  <div class="tl-detail" onclick="this.classList.toggle(\'expanded\')">' + escapeHtml(detail) + '</div>';
      }
      html += '</div>';
    }

    html += '    </div>';
    html += '  </div>';
    html += '</div>';
  }

  if (!html) {
    html = '<div class="empty-state">No cycles found.</div>';
  }

  container.innerHTML = html;
}

function toggleCycle(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.style.display = el.style.display === 'none' || !el.style.display ? 'block' : 'none';
}

// ── SSE — 事件驅動更新 ──

let sseRefreshTimer = null;

function scheduleSSERefresh() {
  if (sseRefreshTimer) return;
  sseRefreshTimer = setTimeout(() => {
    sseRefreshTimer = null;
    fetchAll();
  }, 2000);
}

function connectSSE() {
  const es = new EventSource(API + '/api/events');
  es.onmessage = () => scheduleSSERefresh();
  es.onerror = () => {
    es.close();
    document.getElementById('statusDot').className = 'status-dot error';
    setTimeout(connectSSE, 10000);
  };
}

// Fallback polling
function startFallbackRefresh() {
  setInterval(fetchAll, 60000);
}

// ── Library ──

async function fetchLibrary() {
  try {
    const [catRes, statsRes] = await Promise.all([
      fetch(API + '/api/library'),
      fetch(API + '/api/library/stats'),
    ]);
    if (!catRes.ok) return;
    const cat = await catRes.json();
    const stats = statsRes.ok ? await statsRes.json() : { topCited: [] };
    libraryData = cat.entries || [];

    // Build URL map for Journal↔Library linking
    buildLibUrlMap();

    // Build cited map from stats
    libCitedMap = {};
    for (const tc of (stats.topCited || [])) {
      libCitedMap[tc.id] = tc.count;
    }

    document.getElementById('libraryCount').textContent = libraryData.length;
    document.getElementById('todayLibrary').textContent = libraryData.length;
    renderLibraryTags();
    renderLibrary();

    // Re-render journal with library links now available
    if (allJournalEntries.length > 0) {
      renderJournal(allJournalEntries);
    }
  } catch (e) {
    console.error('Library fetch error:', e);
  }
}

function renderLibraryTags() {
  const tagCounts = {};
  for (const e of libraryData) {
    for (const t of e.tags) tagCounts[t] = (tagCounts[t] || 0) + 1;
  }
  const sorted = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
  const container = document.getElementById('libTags');
  let html = '<span class="lib-tag-chip' + (!libActiveTag ? ' active' : '') + '" data-libtag="">All</span>';
  for (const [tag, count] of sorted) {
    html += '<span class="lib-tag-chip' + (libActiveTag === tag ? ' active' : '') + '" data-libtag="' + escapeHtml(tag) + '">' + escapeHtml(tag) + ' ' + count + '</span>';
  }
  container.innerHTML = html;
}

function renderLibrary() {
  const container = document.getElementById('libraryContent');
  const search = (document.getElementById('libSearch').value || '').toLowerCase();
  const sort = document.getElementById('libSort').value;

  let filtered = libraryData;
  if (libActiveTag) filtered = filtered.filter(e => e.tags.includes(libActiveTag));
  if (search) filtered = filtered.filter(e =>
    e.title.toLowerCase().includes(search) ||
    (e.author || '').toLowerCase().includes(search) ||
    e.tags.some(t => t.includes(search))
  );

  // Sort
  if (sort === 'cited') {
    filtered = [...filtered].sort((a, b) => (libCitedMap[b.id] || 0) - (libCitedMap[a.id] || 0));
  } else {
    filtered = [...filtered].sort((a, b) => (b.accessed || '').localeCompare(a.accessed || ''));
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state">No library entries found.</div>';
    return;
  }

  let html = '';
  for (const e of filtered) {
    const cited = libCitedMap[e.id] || 0;
    const date = (e.accessed || '').split('T')[0];
    const modeClass = e.archiveMode || 'full';
    html += '<div class="lib-card" data-libid="' + escapeHtml(e.id) + '">';
    html += '  <div class="lib-card-title">' + escapeHtml(e.title) + '</div>';
    html += '  <div class="lib-card-meta">';
    if (e.author) html += '<span>' + escapeHtml(e.author) + '</span>';
    html += '    <span>' + date + '</span>';
    html += '    <span class="lib-mode ' + modeClass + '">' + modeClass + '</span>';
    if (cited > 0) html += '    <span class="cited">cited: ' + cited + '</span>';
    html += '  </div>';
    if (e.tags.length > 0) {
      html += '  <div class="lib-card-tags">';
      for (const t of e.tags) html += '<span class="lib-card-tag">' + escapeHtml(t) + '</span>';
      html += '  </div>';
    }
    html += '</div>';
  }
  container.innerHTML = html;
}

async function showLibraryDetail(id) {
  const overlay = document.getElementById('libDetailOverlay');
  const detailContent = document.getElementById('libDetailContent');
  const originalLink = document.getElementById('libOriginalLink');
  detailContent.innerHTML = '<div class="loading"><span>Loading...</span></div>';
  overlay.style.display = 'flex';

  try {
    const [entryRes, citedRes] = await Promise.all([
      fetch(API + '/api/library/' + encodeURIComponent(id)),
      fetch(API + '/api/library/' + encodeURIComponent(id) + '/cited-by'),
    ]);
    if (!entryRes.ok) { detailContent.innerHTML = '<div class="empty-state">Not found</div>'; return; }
    const data = await entryRes.json();
    const cited = citedRes.ok ? await citedRes.json() : { citedBy: [] };
    const e = data.entry;
    originalLink.href = e.url;

    let html = '<div class="lib-detail-title">' + escapeHtml(e.title) + '</div>';
    html += '<div class="lib-detail-meta">';
    if (e.author) html += '<span>' + escapeHtml(e.author) + '</span>';
    if (e.date) html += '<span>' + e.date + '</span>';
    html += '<span>' + (e.accessed || '').split('T')[0] + '</span>';
    html += '<span class="lib-mode ' + (e.archiveMode || 'full') + '">' + (e.archiveMode || 'full') + '</span>';
    html += '<span>' + (e.charCount || 0) + ' chars</span>';
    html += '</div>';

    // Tags
    if (e.tags && e.tags.length > 0) {
      html += '<div class="lib-card-tags" style="margin-bottom:12px;">';
      for (const t of e.tags) html += '<span class="lib-card-tag">' + escapeHtml(t) + '</span>';
      html += '</div>';
    }

    // Cited by
    if (cited.citedBy && cited.citedBy.length > 0) {
      html += '<div class="lib-cited-by">';
      html += '<div class="lib-cited-by-title">Referenced by (' + cited.citedBy.length + ')</div>';
      for (const ref of cited.citedBy) {
        html += '<div class="lib-cited-by-item">' + escapeHtml(ref.file) + ': ' + escapeHtml(ref.line.slice(0, 120)) + '</div>';
      }
      html += '</div>';
    }

    // Content (strip frontmatter)
    let content = data.content || '';
    if (content.startsWith('---')) {
      const endIdx = content.indexOf('---', 4);
      if (endIdx > 0) content = content.slice(endIdx + 3).trim();
    }
    if (content) {
      html += '<div class="lib-content-body">' + escapeHtml(content) + '</div>';
    }

    detailContent.innerHTML = html;
  } catch (err) {
    detailContent.innerHTML = '<div class="empty-state">Error: ' + escapeHtml(String(err)) + '</div>';
  }
}

// Library event listeners
document.getElementById('libSearch').addEventListener('input', renderLibrary);
document.getElementById('libSort').addEventListener('change', renderLibrary);
document.getElementById('libTags').addEventListener('click', function(e) {
  const chip = e.target.closest('[data-libtag]');
  if (!chip) return;
  libActiveTag = chip.dataset.libtag;
  renderLibraryTags();
  renderLibrary();
});
document.getElementById('libraryContent').addEventListener('click', function(e) {
  const card = e.target.closest('[data-libid]');
  if (!card) return;
  showLibraryDetail(card.dataset.libid);
});
document.getElementById('libBack').addEventListener('click', function() {
  document.getElementById('libDetailOverlay').style.display = 'none';
});
document.getElementById('libDetailOverlay').addEventListener('click', function(e) {
  if (e.target === this) this.style.display = 'none';
});

// ── Init ──
fetchAll();
fetchLibrary();
connectSSE();
startFallbackRefresh();
</script>
</body>
</html>
